@using Models
@using DomainAskFor.Models
@using HttpRepository
@using HttpRepository.SynonymsRepository
@using DomainAskFor.Client.Services
@using Radzen.Blazor
@inject IWhoIsHttpRepository whoIsRepository
@inject ISynonymRepository synonymsRepository
@inject ISearchHistoryService searchHistoryService
@inject IAuthService authService

<div class="bg-white/90 backdrop-blur shadow-2xl rounded-2xl p-6 md:p-8 border border-white/50">
  <EditForm Model="searchFormModel" OnValidSubmit="@HandleValidSubmit">
    <DataAnnotationsValidator />
    <ValidationSummary />

    <div class="grid md:grid-cols-2 gap-4">
      <div class="space-y-2">
        <label class="text-sm font-semibold text-slate-700" for="prefix">Prefix (optional)</label>
        <InputText id="prefix"
          class="w-full rounded-xl border border-slate-200 px-4 py-3 text-base focus:outline-none focus:ring-2 focus:ring-brand-500 focus:border-brand-500 bg-white/80"
          @bind-Value="searchFormModel.Prefix" placeholder="e.g., my, get, find" />
      </div>

      <div class="space-y-2">
        <label class="text-sm font-semibold text-slate-700" for="word">Word *</label>
        <InputText id="word"
          class="w-full rounded-xl border border-slate-200 px-4 py-3 text-base focus:outline-none focus:ring-2 focus:ring-brand-500 focus:border-brand-500 bg-white/80"
          @bind-Value="searchFormModel.Word" placeholder="e.g., domain, name" />
      </div>

      <div class="space-y-2">
        <label class="text-sm font-semibold text-slate-700" for="suffix">Suffix (optional)</label>
        <InputText id="suffix"
          class="w-full rounded-xl border border-slate-200 px-4 py-3 text-base focus:outline-none focus:ring-2 focus:ring-brand-500 focus:border-brand-500 bg-white/80"
          @bind-Value="searchFormModel.Suffix" placeholder="e.g., now, online, app" />
      </div>

      <div class="space-y-2">
        <label class="text-sm font-semibold text-slate-700" for="tld">Top Level Domain *</label>
        <select id="tld"
          class="w-full rounded-xl border border-slate-200 px-4 py-3 text-base focus:outline-none focus:ring-2 focus:ring-brand-500 focus:border-brand-500 bg-white/80"
          @bind="searchFormModel.TLD">
          @foreach (Enum e in Enum.GetValues(typeof(TLDModel)))
          {
            <option value="@e">.@e.ToString()</option>
          }
        </select>
      </div>
    </div>

    <div class="mt-6 flex flex-wrap gap-3">
      <button
        class="inline-flex items-center justify-center px-4 py-2.5 rounded-xl font-semibold text-slate-700 bg-slate-100 hover:bg-slate-200 transition"
        type="button" @onclick="@ClearValues">Clear</button>
      <button
        class="inline-flex items-center justify-center px-5 py-3 rounded-xl font-semibold text-white shadow-lg shadow-brand-500/30"
        style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);" type="submit" disabled="@isSearching">
        @if (isSearching)
        {
          <span>Searching...</span>
        }
        else
        {
          <span>Search Domains</span>
        }
      </button>
    </div>
  </EditForm>
</div>

@if (domainResults.Any())
{
  <div class="mt-8 space-y-4">
    <div class="bg-white/90 backdrop-blur rounded-2xl shadow-xl p-6 border border-white/50">
      <h3 class="text-xl font-bold text-slate-800">Domain Search Results</h3>
      <p class="text-slate-600">Found @domainResults.Count domain(s) to check:</p>
    </div>

    @foreach (var result in domainResults)
    {
      <div class="rounded-2xl border border-white/60 shadow-lg p-5 bg-white/90 backdrop-blur">
        <div class="flex flex-wrap items-center justify-between gap-3">
          <div class="text-lg font-semibold text-slate-800">@result.DomainName</div>
          @if (result.IsAvailable)
          {
            <span class="inline-flex items-center px-3 py-1 text-sm font-semibold text-green-700 bg-green-100 rounded-full">✓
              Available</span>
          }
          else
          {
            <span class="inline-flex items-center px-3 py-1 text-sm font-semibold text-rose-700 bg-rose-100 rounded-full">✗
              Taken</span>
          }
        </div>

        @if (result.IsAvailable)
        {
          <div class="mt-3 border-t border-slate-200 pt-3">
            <p class="text-sm text-slate-600 mb-2">Buy this domain at:</p>
            <div class="flex flex-wrap gap-2">
              <a href="@GetRegistrarUrl("namecheap", result.DomainName)" target="_blank"
                class="inline-flex items-center px-3 py-2 text-sm font-semibold text-white rounded-lg"
                style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                Namecheap
              </a>
              <a href="@GetRegistrarUrl("godaddy", result.DomainName)" target="_blank"
                class="inline-flex items-center px-3 py-2 text-sm font-semibold text-white rounded-lg"
                style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                GoDaddy
              </a>
              <a href="@GetRegistrarUrl("squarespace", result.DomainName)" target="_blank"
                class="inline-flex items-center px-3 py-2 text-sm font-semibold text-white rounded-lg"
                style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                Squarespace
              </a>
              <a href="@GetRegistrarUrl("porkbun", result.DomainName)" target="_blank"
                class="inline-flex items-center px-3 py-2 text-sm font-semibold text-white rounded-lg"
                style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                Porkbun
              </a>
            </div>
          </div>
        }
      </div>
    }
  </div>
}

@if (!string.IsNullOrEmpty(errorMessage))
{
  <div class="mt-4 rounded-xl border border-rose-200 bg-rose-50 text-rose-700 px-4 py-3 font-semibold">
    @errorMessage
  </div>
}

@code {
  private SearchFormModel searchFormModel = new SearchFormModel();
  private EditContext editContext;
  private bool isSearching = false;
  private string errorMessage = "";
  private List<DomainSearchResult> domainResults = new List<DomainSearchResult>();

  protected override void OnInitialized()
  {
    editContext = new EditContext(searchFormModel);
  }

  private async Task HandleValidSubmit()
  {
    var isValid = editContext.Validate();
    if (!isValid) return;

    isSearching = true;
    errorMessage = "";
    domainResults.Clear();
    StateHasChanged();

    try
    {
      var urlsToWhoIs = new List<string>();

      // Add the main word
      var mainDomain =
      SanitizeDomainName($"{searchFormModel.Prefix}{searchFormModel.Word}{searchFormModel.Suffix}.{searchFormModel.TLD.ToString()}");
      urlsToWhoIs.Add(mainDomain);

      // Get synonyms and add them
      var wordResponse = await synonymsRepository.GetSynonymsByWord(searchFormModel.Word);
      if (wordResponse?.synonyms != null && wordResponse.synonyms.Count > 0)
      {
        foreach (var synonym in wordResponse.synonyms)
        {
          var synonymDomain =
          SanitizeDomainName($"{searchFormModel.Prefix}{synonym}{searchFormModel.Suffix}.{searchFormModel.TLD.ToString()}");
          urlsToWhoIs.Add(synonymDomain);
        }
      }

      // Check each domain
      foreach (var domain in urlsToWhoIs)
      {
        try
        {
          var whoisResult = await whoIsRepository.GetWhoIsResultByURI(domain);
          domainResults.Add(new DomainSearchResult
          {
            DomainName = domain,
            IsAvailable = whoisResult?.IsAvailable ?? false
          });
        }
        catch
        {
          // If there's an error checking a specific domain, mark it as unavailable
          domainResults.Add(new DomainSearchResult
          {
            DomainName = domain,
            IsAvailable = false
          });
        }
        StateHasChanged(); // Update UI as we check each domain
      }

      // Save search history if user is logged in
      var isAuth = await authService.IsAuthenticated();
      Console.WriteLine($"User authenticated: {isAuth}");

      if (isAuth)
      {
        Console.WriteLine($"Saving search for: {searchFormModel.Word}");
        var saved = await searchHistoryService.SaveSearch(new SaveSearchRequest
        {
          SearchTerm = searchFormModel.Word,
          Prefix = searchFormModel.Prefix,
          Suffix = searchFormModel.Suffix,
          TLD = searchFormModel.TLD.ToString(),
          Results = domainResults.Select(r => new SearchResultItem
          {
            DomainName = r.DomainName,
            IsAvailable = r.IsAvailable
          }).ToList()
        });
        Console.WriteLine($"Search saved: {saved}");
      }
      else
      {
        Console.WriteLine("User not authenticated, skipping save");
      }
    }
    catch (Exception ex)
    {
      errorMessage = $"Error searching domains: {ex.Message}";
    }
    finally
    {
      isSearching = false;
      StateHasChanged();
    }
  }

  private void ClearValues()
  {
    searchFormModel = new SearchFormModel();
    domainResults.Clear();
    errorMessage = "";
  }

  private string GetRegistrarUrl(string registrar, string domainName)
  {
    // Remove the leading dot if present
    domainName = domainName.TrimStart('.');

    return registrar.ToLower() switch
    {
      "namecheap" => $"https://www.namecheap.com/domains/registration/results/?domain={domainName}",
      "godaddy" => $"https://www.godaddy.com/domainsearch/find?checkAvail=1&domainToCheck={domainName}",
      "squarespace" => $"https://domains.squarespace.com/search?query={domainName}",
      "porkbun" => $"https://porkbun.com/checkout/search?q={domainName}",
      _ => $"https://www.namecheap.com/domains/registration/results/?domain={domainName}"
    };
  }

  private string SanitizeDomainName(string domainName)
  {
    if (string.IsNullOrWhiteSpace(domainName))
      return string.Empty;

    // Remove all whitespace
    domainName = domainName.Replace(" ", "");

    // Remove any invalid characters (keep only alphanumeric, hyphens, and dots)
    domainName = System.Text.RegularExpressions.Regex.Replace(domainName, @"[^a-zA-Z0-9\-\.]", "");

    // Remove consecutive hyphens
    domainName = System.Text.RegularExpressions.Regex.Replace(domainName, @"-+", "-");

    // Remove hyphens at the start or end (before the TLD)
    var parts = domainName.Split('.');
    if (parts.Length > 0)
    {
      parts[0] = parts[0].Trim('-');
    }
    domainName = string.Join(".", parts);

    // Convert to lowercase
    domainName = domainName.ToLower();

    return domainName;
  }

  private class DomainSearchResult
  {
    public string DomainName { get; set; }
    public bool IsAvailable { get; set; }
  }
}